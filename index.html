<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>綠色生活地圖</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <!-- Leaflet MarkerCluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        #map { height: 100%; width: 100%; z-index: 0; }
        
        /* 隱藏 Scrollbar */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* --- Cluster 樣式 --- */
        .unified-cluster {
            background: #6b7280;
            color: white;
            border-radius: 50%;
            text-align: center;
            font-weight: bold;
            font-size: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            border: none;
            transition: all 0.3s ease;
        }
        .unified-cluster:active { transform: scale(0.95); }

        /* --- Marker 樣式 --- */
        .custom-marker-pin {
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            box-shadow: 0 3px 8px rgba(0,0,0,0.4);
            font-size: 16px;
            transition: transform 0.2s;
        }

        /* --- 載入動畫 --- */
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #10b981;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- PopUp 美化 --- */
        .leaflet-popup-content-wrapper {
            border-radius: 16px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.15);
            padding: 0;
            overflow: hidden;
        }
        .leaflet-popup-content {
            margin: 0;
            width: 290px !important;
        }
        .leaflet-container a.leaflet-popup-close-button {
            top: 10px; right: 10px; color: #666; font-size: 18px; z-index: 10;
        }
        
        /* --- 介面樣式 --- */
        
        /* 預留空間容器 */
        .info-slot-container {
            height: 50px; 
            margin-top: 8px; 
            display: flex;
            align-items: center;
            justify-content: flex-start; 
            overflow: visible;
            position: relative;
            background: transparent;
            padding: 0;
        }

        /* 1. 上方主分類膠囊按鈕 */
        .category-btn {
            transition: all 0.2s;
            display: inline-flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            padding: 8px 18px;
            border-radius: 9999px; 
            font-size: 0.95rem;
            font-weight: 700;
            border: 1px solid #e5e7eb;
            white-space: nowrap;
            background: white;
            color: #4b5563;
            margin-right: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .category-btn:active { transform: scale(0.95); }
        
        /* 主按鈕 Active: 純黑 (統一) */
        .category-btn.active {
            background: #000000 !important; 
            color: white !important;
            border-color: #000000 !important;
            box-shadow: none !important;
        }

        .category-btn i { font-size: 1.1rem; margin-right: 6px; margin-bottom: 0; }

        /* 2. 下方細項按鈕 - 跟上方一模一樣，只是微縮 */
        .sub-btn {
            transition: all 0.2s;
            display: inline-flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            /* 微縮尺寸 */
            padding: 6px 14px; 
            border-radius: 9999px; 
            font-size: 0.85rem; 
            font-weight: 700;
            border: 1px solid #e5e7eb;
            white-space: nowrap;
            background: white;
            color: #4b5563;
            margin-right: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            animation: fadeInLeft 0.3s ease-out forwards;
        }
        .sub-btn:active { transform: scale(0.95); }

        /* 注意：細項的 Active 顏色現在由 JS 動態控制，移除原本 CSS 中的 !important 黑色 */
        .sub-btn.active {
            color: white !important;
            border-color: transparent !important;
            box-shadow: none !important;
        }

        @keyframes fadeInLeft {
            from { opacity: 0; transform: translateX(-10px); }
            to { opacity: 1; transform: translateX(0); }
        }

        #btn-search {
            white-space: nowrap;
        }

    </style>
</head>
<body class="bg-gray-100">

    <!-- 頂部狀態列 -->
    <div class="absolute top-4 left-4 right-4 z-[1000] flex justify-center pointer-events-none">
        <div id="status-pill" class="bg-white/95 backdrop-blur text-gray-700 px-5 py-2.5 rounded-full shadow-lg text-sm font-medium flex items-center gap-2 transition-all opacity-0 translate-y-[-20px]">
            <div id="loader-spinner" class="loader hidden"></div>
            <span id="status-text">就緒</span>
        </div>
    </div>

    <!-- 底部控制面板 -->
    <div class="absolute bottom-0 left-0 right-0 z-[1000] bg-white/95 backdrop-blur-md rounded-t-3xl shadow-[0_-5px_20px_rgba(0,0,0,0.1)] p-5 pb-8 transition-transform duration-300">
        
        <!-- 標題 -->
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-xl font-bold text-gray-800 flex items-center gap-1">
                <span class="text-green-600"><i class="fa-solid fa-leaf"></i></span>
                綠色地圖
            </h1>
        </div>

        <!-- 1. 主分類膠囊按鈕 -->
        <div class="flex justify-start gap-0 overflow-x-auto no-scrollbar pb-1">
            <button onclick="showSubCategories('transport', this)" class="category-btn">
                <i class="fa-solid fa-car text-blue-500"></i>
                <span>交通</span>
            </button>
            <button onclick="showSubCategories('service', this)" class="category-btn">
                <i class="fa-solid fa-faucet-drip text-cyan-500"></i>
                <span>服務</span>
            </button>
            <button onclick="showSubCategories('rest', this)" class="category-btn">
                <i class="fa-solid fa-tree text-emerald-500"></i>
                <span>休憩</span>
            </button>
            <button onclick="showSubCategories('shop', this)" class="category-btn">
                <i class="fa-solid fa-store text-rose-500"></i>
                <span>消費</span>
            </button>
        </div>

        <!-- 2. 預留空間 -->
        <div id="info-slot" class="info-slot-container">
            
            <!-- 左側：細項選單 -->
            <div id="sub-menu-container" class="flex-1 flex justify-start items-center overflow-x-auto no-scrollbar h-full">
                <!-- 預設提示 -->
                <p id="default-hint" class="text-gray-400 text-sm pl-1">請先選擇上方類別</p>
            </div>

            <!-- 右側：搜尋按鈕 -->
            <button id="btn-search" class="bg-gray-200 text-gray-400 px-6 py-3 rounded-full text-sm font-bold transition-all flex items-center gap-2 flex-shrink-0 ml-4 cursor-not-allowed" disabled onclick="handleSearchClick()">
                <i class="fa-solid fa-magnifying-glass"></i> 開始搜尋
            </button>

        </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

    <script>
        // --- 變數 ---
        let map, userMarker, markerClusterGroup;
        let fetchedData = [];
        let userPos = null; 
        let currentSelectedItem = null; 
        let statusTimeout = null;

        // UI 參考
        const statusPill = document.getElementById('status-pill');
        const statusText = document.getElementById('status-text');
        const loader = document.getElementById('loader-spinner');
        const btnSearch = document.getElementById('btn-search');

        // --- 資料設定 (使用 Hex 顏色確保顯示正確) ---
        const categoryConfig = {
            transport: {
                activeHex: '#3b82f6', // 交通藍
                items: [
                    { id: 'bus', name: '公車站', query: 'nwr["highway"="bus_stop"]', type: 'bus' },
                    { id: 'train', name: '火車', query: 'nwr["railway"="station"];nwr["station"="subway"]', type: 'train' },
                    { id: 'bike', name: '單車', query: 'nwr["amenity"="bicycle_rental"]', type: 'bike' }
                ]
            },
            service: {
                activeHex: '#06b6d4', // 服務青
                items: [
                    { id: 'water', name: '飲水機', query: 'nwr["amenity"="drinking_water"]', type: 'water' },
                    { id: 'toilet', name: '廁所', query: 'nwr["amenity"="toilets"]', type: 'toilet' },
                    { id: 'recycle', name: '回收站', query: 'nwr["amenity"="recycling"]', type: 'recycle' }
                ]
            },
            rest: {
                activeHex: '#10b981', // 休憩綠
                items: [
                    { id: 'park', name: '公園', query: 'nwr["leisure"="park"];nwr["leisure"="garden"]', type: 'park' },
                    { id: 'library', name: '圖書館', query: 'nwr["amenity"="library"]', type: 'library' },
                    { id: 'beach', name: '海灘', query: 'nwr["natural"="beach"]', type: 'beach' }
                ]
            },
            shop: {
                activeHex: '#f43f5e', // 消費紅
                items: [
                    { id: 'food', name: '蔬食餐廳', query: 'nwr["diet:vegetarian"="yes"];nwr["diet:vegan"="yes"]', type: 'food' },
                    { id: 'secondhand', name: '二手', query: 'nwr["shop"="second_hand"];nwr["shop"="charity"]', type: 'secondhand' },
                    { id: 'market', name: '市場', query: 'nwr["amenity"="marketplace"]', type: 'market' }
                ]
            }
        };

        // --- 初始化 ---
        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([23.6, 121.0], 7);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OSM', maxZoom: 19
            }).addTo(map);

            markerClusterGroup = L.markerClusterGroup({
                showCoverageOnHover: false,
                zoomToBoundsOnClick: true,
                maxClusterRadius: 80, 
                iconCreateFunction: function(cluster) {
                    const count = cluster.getChildCount();
                    let size = count > 99 ? 45 : 40;
                    return L.divIcon({
                        html: `<span>${count}</span>`,
                        className: 'unified-cluster', 
                        iconSize: L.point(size, size)
                    });
                }
            });
            map.addLayer(markerClusterGroup);
        }

        // --- 定位功能 ---
        function locateUserAndSearch() {
            showStatus('定位中...', true); 
            
            if (!navigator.geolocation) { 
                showStatus('裝置不支援定位', false); 
                return; 
            }
            
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    userPos = [pos.coords.latitude, pos.coords.longitude];
                    map.setView(userPos, 16);
                    updateUserMarker();
                    executeSearch(); 
                },
                (err) => { 
                    console.error(err); 
                    showStatus('無法取得位置', false); 
                    btnSearch.disabled = false;
                    btnSearch.innerHTML = `<i class="fa-solid fa-magnifying-glass"></i> 開始搜尋`;
                },
                { enableHighAccuracy: true, timeout: 10000 }
            );
        }

        function updateUserMarker() {
            if (userMarker) map.removeLayer(userMarker);
            const userIcon = L.divIcon({
                html: '<div class="w-4 h-4 bg-blue-500 border-2 border-white rounded-full shadow-md"></div>',
                className: '', iconSize: [16, 16]
            });
            userMarker = L.marker(userPos, {icon: userIcon}).addTo(map);
        }

        // --- 顯示細項 (關鍵邏輯優化) ---
        function showSubCategories(groupKey, btnElement) {
            // 1. 重置搜尋按鈕
            resetSearchButton();

            // 2. 更新主按鈕狀態 (變黑)
            document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
            btnElement.classList.add('active');

            // 3. 處理容器 - 加入判斷防止錯誤
            const hint = document.getElementById('default-hint');
            const container = document.getElementById('sub-menu-container');
            
            // 檢查 hint 是否存在才進行操作
            if (hint) {
                hint.classList.add('hidden');
            }
            
            // 強制清空容器內容，解決刷新問題
            container.innerHTML = ''; 

            // 4. 獲取該類別配置
            const config = categoryConfig[groupKey]; 
            const activeColor = config.activeHex;

            // 5. 生成子按鈕
            config.items.forEach((item, index) => {
                const subBtn = document.createElement('button');
                subBtn.className = 'sub-btn'; // 套用預設樣式
                subBtn.innerHTML = item.name;
                subBtn.style.animationDelay = `${index * 50}ms`;
                
                // 點擊事件：套用父類別顏色
                subBtn.onclick = () => {
                    // 重置同容器內所有按鈕 (變回白底)
                    container.querySelectorAll('.sub-btn').forEach(sb => {
                        sb.classList.remove('active');
                        sb.style.backgroundColor = 'white';
                        sb.style.color = '#4b5563';
                        sb.style.borderColor = '#e5e7eb';
                    });
                    
                    // 激活當前按鈕 (變父類別顏色)
                    subBtn.classList.add('active');
                    subBtn.style.backgroundColor = activeColor;
                    subBtn.style.borderColor = activeColor;
                    subBtn.style.color = 'white';
                    
                    selectSubItem(item);
                };
                
                container.appendChild(subBtn);
            });
        }

        function selectSubItem(item) {
            currentSelectedItem = item;
            btnSearch.disabled = false;
            btnSearch.classList.remove('bg-gray-200', 'text-gray-400', 'cursor-not-allowed');
            btnSearch.classList.add('bg-green-600', 'hover:bg-green-700', 'shadow-green-200', 'text-white');
            btnSearch.innerHTML = `<i class="fa-solid fa-magnifying-glass"></i> 開始搜尋`;
        }

        // --- 點擊搜尋按鈕 ---
        function handleSearchClick() {
            if (!currentSelectedItem) return;
            
            btnSearch.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> 處理中`;
            btnSearch.disabled = true;

            if (!userPos) {
                locateUserAndSearch();
            } else {
                executeSearch();
            }
        }

        // --- 執行搜尋邏輯 ---
        async function executeSearch() {
            const item = currentSelectedItem;
            const btn = btnSearch;

            markerClusterGroup.clearLayers();

            try {
                // 第一階段
                showStatus(`搜尋中...`, true); 
                let data = await fetchOverpass(item.query, 1000);

                if (data.elements.length > 0) {
                    processData(data.elements, item.type);
                    fitMapToBounds(data.elements);
                    showStatus(`找到 ${data.elements.length} 個地點`, false);
                } else {
                    // 第二階段
                    data = await fetchOverpass(item.query, 5000);
                    
                    if (data.elements.length > 0) {
                        processData(data.elements, item.type);
                        fitMapToBounds(data.elements);
                        showStatus(`找到 ${data.elements.length} 個地點`, false);
                    } else {
                        showStatus(`附近沒有找到相關地點`, false);
                    }
                }
            } catch (e) {
                console.error(e);
                showStatus('連線錯誤', false);
            } finally {
                btn.disabled = false;
                btn.innerHTML = `<i class="fa-solid fa-rotate-right"></i> 重新搜尋`;
            }
        }

        function resetSearchButton() {
            currentSelectedItem = null;
            btnSearch.disabled = true;
            btnSearch.className = "bg-gray-200 text-gray-400 px-6 py-3 rounded-full text-sm font-bold transition-all flex items-center gap-2 flex-shrink-0 ml-4 cursor-not-allowed";
            btnSearch.innerHTML = `<i class="fa-solid fa-magnifying-glass"></i> 開始搜尋`;
        }

        async function fetchOverpass(queryPart, radius) {
            const parts = queryPart.split(';');
            let finalQueryBody = '';
            parts.forEach(p => {
                if(p.trim()) {
                    finalQueryBody += `${p}(around:${radius},${userPos[0]},${userPos[1]});`;
                }
            });
            const query = `[out:json][timeout:25];(${finalQueryBody});out center;`;
            const res = await fetch('https://overpass-api.de/api/interpreter', { method: 'POST', body: query });
            return await res.json();
        }

        function fitMapToBounds(elements) {
            if (elements.length === 0) return;
            const bounds = L.latLngBounds([userPos]); 
            elements.forEach(el => {
                const lat = el.lat || el.center?.lat;
                const lon = el.lon || el.center?.lon;
                if (lat && lon) bounds.extend([lat, lon]);
            });
            map.fitBounds(bounds, { padding: [50, 50], maxZoom: 16 });
        }

        // --- 資料處理與渲染 ---
        function processData(elements, forcedType) {
            fetchedData = [];
            
            elements.forEach(el => {
                const lat = el.lat || el.center?.lat;
                const lng = el.lon || el.center?.lon;
                if (!lat || !lng) return;

                const tags = el.tags || {};
                const type = forcedType; 
                let displayName = tags.name;
                const catName = getCategoryName(type);
                if (!displayName) displayName = catName;

                let address = '';
                if (tags['addr:city']) address += tags['addr:city'];
                if (tags['addr:district']) address += tags['addr:district'];
                if (tags['addr:street']) address += tags['addr:street'];
                if (!address && tags.location) address = tags.location;

                const details = {
                    opening_hours: tags.opening_hours,
                    wheelchair: tags.wheelchair
                };

                const style = getVibrantStyle(type);

                const markerHtml = `<div class="custom-marker-pin ${style.color} w-10 h-10"><i class="fa-solid ${style.icon} text-white"></i></div>`;
                
                const customIcon = L.divIcon({
                    html: markerHtml, className: '', iconSize: [40, 40], iconAnchor: [20, 40], popupAnchor: [0, -45]
                });

                let detailsHtml = '';
                if (address) detailsHtml += `<div class="text-sm text-gray-600 mb-1"><i class="fa-solid fa-location-dot w-4 text-center text-gray-400"></i> ${address}</div>`;
                if (details.opening_hours) detailsHtml += `<div class="text-sm text-green-600 mb-1"><i class="fa-regular fa-clock w-4 text-center"></i> ${details.opening_hours}</div>`;
                
                const googleMapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;

                const popupContent = `
                    <div class="flex flex-col relative pb-1">
                        <div class="bg-gray-50 p-3 border-b border-gray-100">
                            <h3 class="font-bold text-gray-800 text-base leading-tight pr-6">${displayName}</h3>
                            <span class="text-xs text-gray-500 mt-1 inline-block bg-white border px-2 py-0.5 rounded-full">${catName}</span>
                        </div>
                        <div class="p-3 mb-2">
                            ${detailsHtml || '<span class="text-gray-400 text-sm">無詳細資訊</span>'}
                        </div>
                        <div class="flex justify-end px-3 pb-3">
                            <a href="${googleMapsUrl}" target="_blank" rel="noopener noreferrer" 
                               style="color: white !important;" 
                               class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-1.5 rounded-full text-xs font-bold shadow-sm flex items-center gap-1 transition-colors">
                                <i class="fa-solid fa-location-arrow" style="color: white;"></i> 導航
                            </a>
                        </div>
                    </div>
                `;

                markerClusterGroup.addLayer(L.marker([lat, lng], { icon: customIcon }).bindPopup(popupContent));
            });
        }

        // --- 狀態顯示優化：自動消失 ---
        function showStatus(msg, isLoading) {
            if (statusTimeout) clearTimeout(statusTimeout);

            statusPill.classList.remove('opacity-0', 'translate-y-[-20px]');
            statusPill.style.pointerEvents = 'auto';
            statusText.textContent = msg;
            loader.classList.toggle('hidden', !isLoading);

            if (!isLoading) {
                statusTimeout = setTimeout(() => {
                    hideStatus();
                }, 3000); 
            }
        }

        function hideStatus() {
            statusPill.classList.add('opacity-0', 'translate-y-[-20px]');
            statusPill.style.pointerEvents = 'none';
        }

        function getCategoryName(type) {
            const map = { 
                'bus': '公車站', 'train': '火車站', 'bike': '單車租借',
                'water': '飲水機', 'toilet': '廁所', 'recycle': '回收站',
                'park': '公園', 'beach': '海灘', 'library': '圖書館', 
                'food': '蔬食餐廳', 'secondhand': '二手店', 'market': '傳統市場'
            };
            return map[type] || '地點';
        }

        function getVibrantStyle(type) {
            let colorClass = 'bg-gray-500'; 
            let iconClass = 'fa-map-pin';
            const styles = {
                'bus':   { color: 'bg-blue-500', icon: 'fa-bus' },
                'train': { color: 'bg-indigo-500', icon: 'fa-train-subway' },
                'bike':  { color: 'bg-orange-400', icon: 'fa-bicycle' },
                'water':   { color: 'bg-cyan-400', icon: 'fa-faucet-drip' },
                'toilet':  { color: 'bg-purple-500', icon: 'fa-restroom' },
                'recycle': { color: 'bg-lime-500', icon: 'fa-recycle' },
                'park':   { color: 'bg-emerald-500', icon: 'fa-tree' },
                'beach':  { color: 'bg-amber-400', icon: 'fa-umbrella-beach' },
                'library':{ color: 'bg-violet-400', icon: 'fa-book' },
                'food':       { color: 'bg-green-400', icon: 'fa-carrot' },
                'secondhand': { color: 'bg-pink-400', icon: 'fa-shirt' },
                'market':     { color: 'bg-orange-500', icon: 'fa-basket-shopping' } 
            };
            if (styles[type]) return styles[type];
            return { color: colorClass, icon: iconClass };
        }

        initMap();
    </script>
</body>
</html>
